<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chamada | Professor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .row { display: flex; gap: 24px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; min-width: 280px; }
    #qr { width: 256px; height: 256px; border: 1px dashed #999; display:flex; align-items:center; justify-content:center; }
    ul { list-style: none; padding: 0; }
    li { padding: 6px 0; border-bottom: 1px solid #eee; }
    button { padding: 10px 16px; border-radius: 8px; border: 0; cursor: pointer; }
    button.primary { background: black; color: white; }
    .hidden { display:none; }
    a.primary, .btnlike { padding: 10px 16px; border-radius: 8px; background: black; color: white; text-decoration: none; display: inline-block; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Chamada (Professor)</h1>

  <div class="card">
    <label>Nome da aula/evento</label><br/>
    <input id="lesson" placeholder="Ex: Aula de Matemática" style="width: 320px; padding:8px;"/>
    <button id="start" class="primary">Iniciar Chamada</button>
  </div>

  <div id="live" class="row hidden">
    <div class="card">
      <h3>QR Code</h3>
      <div id="qr">QR...</div>
      <p><small>Alunos devem escanear o QR e permitir localização</small></p>
      <p id="joinLink"></p>
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        <button id="close" style="background:#e53935;color:#fff">Fechar Chamada</button>
        <button id="new" class="primary">Nova Chamada</button>
      </div>
      <div id="exports" class="hidden" style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
        <span id="dlXlsx" class="btnlike">Baixar Excel</span>
        <span id="dlDocx" class="btnlike">Baixar Word</span>
      </div>
    </div>

    <div class="card" style="flex:1">
      <h3>Presentes</h3>
      <ul id="list"></ul>
      <p><b>Total:</b> <span id="count">0</span></p>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const startBtn = document.getElementById('start');
    const lessonInput = document.getElementById('lesson');
    const live = document.getElementById('live');
    const qrDiv = document.getElementById('qr');
    const list = document.getElementById('list');
    const count = document.getElementById('count');
    const closeBtn = document.getElementById('close');
    const newBtn = document.getElementById('new');
    const joinLinkP = document.getElementById('joinLink');
    const exportsDiv = document.getElementById('exports');
    const dlXlsx = document.getElementById('dlXlsx');
    const dlDocx = document.getElementById('dlDocx');

    let sessionId = null;
    let socket = null;

    const LS_KEY = 'qr-attendance:host';

    function saveState() {
      localStorage.setItem(LS_KEY, JSON.stringify({
        sessionId,
        lessonName: lessonInput.value.trim() || ''
      }));
    }
    function clearState() {
      localStorage.removeItem(LS_KEY);
    }
    function loadState() {
      try { return JSON.parse(localStorage.getItem(LS_KEY) || 'null'); }
      catch { return null; }
    }

    async function getLocation() {
      return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
          (pos) => resolve({ lat: pos.coords.latitude, lng: pos.coords.longitude }),
          (err) => reject(err),
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      });
    }

    function clearUI() {
      list.innerHTML = '';
      count.textContent = '0';
      exportsDiv.classList.add('hidden');
      qrDiv.innerHTML = 'QR...';
      joinLinkP.innerHTML = '';
    }

    function addAttendee(a) {
      const li = document.createElement('li');
      const dt = new Date(a.time);
      li.textContent = `${a.name} — ${a.rgm} (${dt.toLocaleTimeString()})`;
      list.prepend(li);
      count.textContent = Number(count.textContent) + 1;
    }

    function connectSocketAndListen() {
      if (socket) socket.disconnect();
      socket = io();
      socket.emit('host:join', sessionId);
      socket.on('attendee:new', (a) => addAttendee(a));
    }

    async function hydrateFromSnapshot() {
      const snapRes = await fetch('/api/sessions/' + sessionId);
      if (!snapRes.ok) {
        clearState();
        clearUI();
        live.classList.add('hidden');
        return;
      }
      const snap = await snapRes.json();
      live.classList.remove('hidden');
      lessonInput.value = snap.name || '';

      const joinUrl = `${location.origin}/join.html?id=${snap.id}`;
      joinLinkP.innerHTML = `<small>Link: <a href="${joinUrl}" target="_blank">${joinUrl}</a></small>`;

      clearUI();
      for (const a of snap.attendees) addAttendee(a);

      if (snap.active === false) {
        exportsDiv.classList.remove('hidden');
        dlXlsx.onclick = () => window.open('/api/sessions/' + sessionId + '/export.xlsx', '_self');
        dlDocx.onclick = () => window.open('/api/sessions/' + sessionId + '/export.docx', '_self');
      }
      connectSocketAndListen();
    }

    window.addEventListener('load', async () => {
      const saved = loadState();
      if (saved && saved.sessionId) {
        sessionId = saved.sessionId;
        await hydrateFromSnapshot();
      }
    });

    startBtn.onclick = async () => {
      const name = lessonInput.value.trim();
      if (!name) { alert('Digite o nome da aula'); return; }
      try {
        const loc = await getLocation();
        const resp = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, lat: loc.lat, lng: loc.lng })
        });
        const data = await resp.json();
        if (!resp.ok) { alert(data.error || 'Erro'); return; }

        sessionId = data.id;
        saveState();

        live.classList.remove('hidden');
        qrDiv.innerHTML = `<img alt="QR" src="${data.qrPng}" width="256" height="256"/>`;
        joinLinkP.innerHTML = `<small>Link: <a href="${data.joinUrl}" target="_blank">${data.joinUrl}</a></small>`;

        connectSocketAndListen();

        const snap = await fetch('/api/sessions/' + sessionId).then(r=>r.json());
        clearUI();
        for (const a of snap.attendees) addAttendee(a);
      } catch (e) {
        console.error(e);
        alert('Precisamos da sua localização para iniciar.');
      }
    };

    closeBtn.onclick = async () => {
      if (!sessionId) return;
      const r = await fetch('/api/sessions/' + sessionId + '/close', { method: 'POST' });
      if (!r.ok) { alert('Não foi possível fechar a chamada'); return; }
      exportsDiv.classList.remove('hidden');
      dlXlsx.onclick = () => window.open('/api/sessions/' + sessionId + '/export.xlsx', '_self');
      dlDocx.onclick = () => window.open('/api/sessions/' + sessionId + '/export.docx', '_self');
      saveState();
    };

    newBtn.onclick = async () => {
      const defaultName = lessonInput.value.trim() || '';
      const name = prompt('Nome da aula/evento da nova chamada:', defaultName);
      if (!name) return;

      try {
        const loc = await getLocation();
        const resp = await fetch('/api/sessions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, lat: loc.lat, lng: loc.lng })
        });
        const data = await resp.json();
        if (!resp.ok) { alert(data.error || 'Erro'); return; }

        clearUI();
        sessionId = data.id;
        lessonInput.value = name;
        saveState();

        live.classList.remove('hidden');
        qrDiv.innerHTML = `<img alt="QR" src="${data.qrPng}" width="256" height="256"/>`;
        joinLinkP.innerHTML = `<small>Link: <a href="${data.joinUrl}" target="_blank">${data.joinUrl}</a></small>`;

        connectSocketAndListen();

        const snap = await fetch('/api/sessions/' + sessionId).then(r=>r.json());
        clearUI();
        for (const a of snap.attendees) addAttendee(a);
      } catch (e) {
        console.error(e);
        alert('Precisamos da sua localização para iniciar a nova chamada.');
      }
    };

    // depois de exportar, o servidor apaga a sessão; vamos conferir e limpar
    async function checkIfSessionStillExists() {
      if (!sessionId) return;
      const r = await fetch('/api/sessions/' + sessionId);
      if (r.status === 404) {
        clearState();
        clearUI();
        live.classList.add('hidden');
        if (socket) socket.disconnect();
        alert('Chamada finalizada e dados apagados.');
      }
    }
    dlXlsx && dlXlsx.addEventListener('click', () => setTimeout(checkIfSessionStillExists, 3000));
    dlDocx && dlDocx.addEventListener('click', () => setTimeout(checkIfSessionStillExists, 3000));
  </script>
</body>
</html>
